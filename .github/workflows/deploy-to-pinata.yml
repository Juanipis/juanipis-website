name: Deploy to Pinata

on:
  push:
    branches: [master]
  workflow_dispatch: # Permite ejecutar manualmente

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Build project
        run: npm run build

      - name: Verify build output
        run: |
          ls -la out/
          echo "Build completed successfully"

      - name: Prepare files for upload
        run: |
          # Create a single tar file that Pinata will extract and serve properly
          cd out
          tar -cf ../website-directory.tar *
          cd ..
          ls -la website-directory.tar

      - name: Upload directory to Pinata
        id: upload
        run: |
          # Use the legacy endpoint which supports directory uploads
          response=$(curl -s -X POST "https://api.pinata.cloud/pinning/pinFileToIPFS" \
            -H "Authorization: Bearer ${{ secrets.PINATA_JWT }}" \
            -F "file=@website-directory.tar" \
            -F "pinataMetadata={\"name\":\"juanipis-website-$(date +%Y%m%d-%H%M%S)\",\"keyvalues\":{\"type\":\"static-site\",\"framework\":\"nextjs\"}}" \
            -F "pinataOptions={\"cidVersion\":1,\"wrapWithDirectory\":false}")

          echo "Upload response: $response"

          # Check for errors
          if echo "$response" | grep -q '"error"'; then
            echo "âŒ Upload failed with error:"
            echo "$response"
            exit 1
          fi

          # Extract IPFS hash from response
          ipfs_hash=$(echo "$response" | grep -o '"IpfsHash":"[^"]*' | cut -d'"' -f4)
          echo "IPFS Hash: $ipfs_hash"

          if [ -z "$ipfs_hash" ]; then
            echo "âŒ Failed to extract IPFS hash from response"
            echo "Full response: $response"
            exit 1
          fi

          echo "âœ… Successfully uploaded to IPFS: $ipfs_hash"

          # Save to GitHub outputs
          echo "ipfs_hash=$ipfs_hash" >> $GITHUB_OUTPUT
          echo "gateway_url=https://gateway.pinata.cloud/ipfs/$ipfs_hash" >> $GITHUB_OUTPUT

      - name: Create deployment summary
        run: |
          echo "## ðŸŽ‰ Website deployed to IPFS!" >> $GITHUB_STEP_SUMMARY
          echo "**IPFS Hash:** ${{ steps.upload.outputs.ipfs_hash }}" >> $GITHUB_STEP_SUMMARY
          echo "**Gateway URL:** ${{ steps.upload.outputs.gateway_url }}" >> $GITHUB_STEP_SUMMARY
          echo "**Deployment Time:** $(date)" >> $GITHUB_STEP_SUMMARY
